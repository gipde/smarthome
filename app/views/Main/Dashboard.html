{{template "Main/mheader.html" .}}

<div class="container">
    <div class="page-header">
        <h3><span></span> Geräteübersicht <a href="/main/createdev">create</a> </h3>
    </div>
    <div id="connection-error"> </div>
    <div class="container">
        {{range $index,$value:=.devices}}
        <div class="row-fluid border">
            <div class="col-md-4 bordered">
                <div class="panel panel-default center">
                    <div class="panel-heading center" style="text-align: center">
                        device-{{.ID}}<br>{{$value.Name}}
                    </div>
                    <div class="panel-body">
                        <div id="device-{{.ID}}" class="circle center">{{.State}}</div>
                    </div>
                </div>
            </div>
        </div>
        {{ end }}

        <script>
            // Create a socket
            var socket = new WebSocket('ws://' + window.location.host + '/Main/DeviceFeed');
            $(document).ready(function() {

                // Message received on the socket
                socket.onmessage = function(event) {
                    state = JSON.parse(event.data)
                    console.log(state)
                    switch (state.Command) {
                        case "STATERESPONSE":
                            // Text
                            $("#" + state.Device).html(state.State)

                            // State-Border
                            if (state.Connected) {
                                $("#" + state.Device).addClass("connected")

                            } else {
                                $("#" + state.Device).removeClass("connected")
                            }

                            // State Background
                            switch (state.State) {
                                case "ON":
                                    $("#" + state.Device).addClass("switchedOn")
                                    break;
                                case "OFF":
                                    $("#" + state.Device).removeClass("switchedOn")
                                    break;
                            }
                            break;
                        case "STATEUPDATE":
                            // Text
                            $("#" + state.Device).html(state.State)

                            // State-Border
                            if (state.Connected) {
                                $("#" + state.Device).addClass("connected")

                            } else {
                                $("#" + state.Device).removeClass("connected")
                            }

                            // State Background
                            switch (state.State) {
                                case "ON":
                                    $("#" + state.Device).addClass("switchedOn")
                                    break;
                                case "OFF":
                                    $("#" + state.Device).removeClass("switchedOn")
                                    break;
                            }
                            break;

                    }
                }

                // wait until socket is connected
                // TODO: Nice UI State to display state of Websocket
                connectionError = $("#connection-error")
                setTimeout(() => {
                    if (socket.readyState !== 1) {
                        connectionError.html("error connecting websocket");
                    }
                }, 100); // ms

                socket.onopen = function() {

                    $(".circle").click(function() {
                        currentState = $(this).text()
                        var newstate
                        switch (currentState) {
                            case "ON":
                                newstate = "OFF"
                                break;
                            case "OFF":
                                newstate = "ON"
                                break;
                            case "":
                                newstate = "ON"
                                break;
                        }
                        transmit = {
                            "Command": "SETSTATE",
                            "Device": $(this)[0].id,
                            "State": newstate
                        }
                        socket.send(JSON.stringify(transmit))
                    });

                    // initially, we fetch the state of the device
                    $(".circle").each(function(index) {
                        socket.send(JSON.stringify({
                            "Command": "GETSTATE",
                            "Device": $(this)[0].id
                        }))
                    })
                }

            });

            $(window).unload(function() {
                socket.close()
                console.log("We leave the page")
                    // return "Handler for .unload() called.";
            });
        </script>

        {{template "Main/mfooter.html" .}}